# Breaking change was removing the bit timing sections from hal::can::settings,
# now it is just baud_rate.
name: ðŸš€ Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            profile_path: profiles/x86_64/mac-14/

          - os: macos-15
            profile_path: profiles/x86_64/mac-15/

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4.1.1

      - name: ðŸ“¥ Install OS Specific Tools (macos-14)
        if: ${{ matrix.os == 'macos-14' }}
        run: |
          brew install llvm@17
          ln -s $(brew --prefix llvm@17)/bin/clang-tidy /usr/local/bin/
          brew install pipx
          pipx ensurepath

      - name: ðŸ“¥ Install OS Specific Tools (macos-15)
        if: ${{ matrix.os == 'macos-15' }}
        run: |
          brew install llvm@17
          ln -s $(brew --prefix llvm@17)/bin/clang-tidy /usr/local/bin/
          brew install pipx
          pipx ensurepath

      - name: ðŸ“¥ Install Conan 2.18.0
        run: pipx install conan==2.18.0

      - name: ðŸ” conan version
        run: conan --version

      - name: ðŸ” cmake version
        run: cmake --version

      - name: ðŸ” clang++ version
        run: clang++-17 --version || clang++ --version

      - name: ðŸ” /usr/bin version
        run: ls /usr/bin/clang*

      - name: ðŸ” clang-tidy version
        run: clang-tidy-17 --version || clang-tidy --version

      - name: ðŸ“¡ Add `libhal` repo to conan remotes
        run: conan remote add libhal
          https://libhal.jfrog.io/artifactory/api/conan/trunk-conan

      - name: ðŸ“¡ Create and setup default profile
        run: conan profile detect --force

      - name: ðŸ‘ï¸â€ðŸ—¨ï¸ Show conan profile (original)
        run: conan profile show

      - name: ðŸ“¡ Install default system profile for ${{ matrix.os }}
        run: conan config install -sf ${{ matrix.profile_path }} https://github.com/libhal/conan-config.git

      - name: ðŸ“¡ Install libhal platform profiles for mac
        run: conan config install -sf conan/profiles/v1 -tf profiles https://github.com/libhal/libhal-mac.git

      - name: ðŸ‘ï¸â€ðŸ—¨ï¸ Show conan profile (new)
        run: conan profile show

      - name: ðŸ“¡ Install libhal settings_user.yml
        run: conan config install -sf profiles/baremetal/v2 https://github.com/libhal/conan-config.git

      - name: Set Version Environment Variable
        run: |
          if [ -z "${{ github.ref_name }}" ]; then
            echo "VERSION=latest" >> $GITHUB_ENV
          else
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      - name: ðŸ“¦ Create `Debug` package for ${{ inputs.profile }}
        run: conan create . -pr mac-hal -s build_type=Debug --version=${{ env.VERSION }}

      - name: ðŸ“¦ Create `RelWithDebInfo` package for ${{ inputs.profile }}
        run: conan create . -pr mac-hal -s build_type=RelWithDebInfo --version=${{ env.VERSION }}

      - name: ðŸ“¦ Create `MinSizeRel` package for ${{ inputs.profile }}
        run: conan create . -pr mac-hal -s build_type=MinSizeRel --version=${{ env.VERSION }}

      - name: ðŸ“¦ Create `Release` package for ${{ inputs.profile }}
        run: conan create . -pr mac-hal -s build_type=Release --version=${{ env.VERSION }}

      - name: ðŸ§± Build demos (Debug)
        run: conan build demos -pr mac-hal -s build_type=Debug

      - name: ðŸ§± Build demos (RelWithDebInfo)
        run: conan build demos -pr mac-hal -s build_type=RelWithDebInfo

      - name: ðŸ§± Build demos (MinSizeRel)
        run: conan build demos -pr mac-hal -s build_type=MinSizeRel

      - name: ðŸ§± Build demos (Release)
        run: conan build demos -pr mac-hal -s build_type=Release

      - name: ðŸ“¡ Sign into JFrog Artifactory
        if: ${{ inputs.version != '' }}
        env:
          PASSWORD: ${{ secrets.JFROG_LIBHAL_TRUNK_ID_TOKEN }}
          JFROG_USER: ${{ secrets.JFROG_LIBHAL_TRUNK_ID_TOKEN_USER }}
        run: conan remote login -p $PASSWORD libhal $JFROG_USER

      - name: ðŸ†™ Upload package version ${{ github.ref_name }} to `libhal` repo
        run: conan upload "libhal-mac/${{ github.ref_name }}" --confirm -r=libhal
