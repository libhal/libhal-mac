# Breaking change was removing the bit timing sections from hal::can::settings,
# now it is just baud_rate.
name: ðŸš€ Deploy

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
          - os: macos-15

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4.1.1
      - run: pipx install conan>=2.18.0
      - run: conan --version
      - run: conan config install https://github.com/libhal/conan-config2.git
      - run: conan hal setup
      - run: conan profile show
      - run: conan create . -pr:a hal/tc/llvm -s build_type=Debug --version=${{ github.ref_name }}
      - run: conan create . -pr:a hal/tc/llvm -s build_type=MinSizeRel --version=${{ github.ref_name }}
      - run: conan create . -pr:a hal/tc/llvm -s build_type=Release --version=${{ github.ref_name }}

      - name: ðŸ“¡ Sign into JFrog Artifactory
        env:
          PASSWORD: ${{ secrets.JFROG_LIBHAL_TRUNK_ID_TOKEN }}
          JFROG_USER: ${{ secrets.JFROG_LIBHAL_TRUNK_ID_TOKEN_USER }}
        run: conan remote login -p $PASSWORD libhal $JFROG_USER

      - name: ðŸ†™ Upload package libhal-mac/${{ github.ref_name }} to remote
        run: conan upload "libhal-mac/${{ github.ref_name }}" --confirm -r=libhal
